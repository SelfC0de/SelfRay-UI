<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/jpeg" href="data:image/jpeg;base64,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">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SelfRay-UI ‚Äî Panel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080d;--card:rgba(16,16,26,.85);--card-solid:#10101a;--border:rgba(40,40,70,.5);--text:#e0e0e0;--muted:#667;--accent:#00c8ff;--accent2:#7b2fff;--accent3:#00ff88;--danger:#ff4757;--success:#2ed573;--warn:#ffa502;--glow:0 0 20px rgba(0,200,255,.08)}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(123,47,255,.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(0,200,255,.04) 0%,transparent 60%);pointer-events:none;z-index:0}

.hdr{background:linear-gradient(135deg,rgba(16,16,26,.95),rgba(20,20,35,.95));backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.3)}
.hdr h1{font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-r{display:flex;gap:10px;align-items:center}
.hdr-r span{color:var(--muted);font-size:12px}
.wrap{max-width:1200px;margin:0 auto;padding:16px;position:relative;z-index:1}

.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:16px}
.tab{padding:8px 16px;cursor:pointer;color:var(--muted);font-size:13px;border-bottom:2px solid transparent;transition:all .3s}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

.tc{display:none;animation:fadeUp .4s ease}.tc.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideIn{from{opacity:0;transform:translateY(-20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes toastIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(120%);opacity:0}}

.card{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;transition:border-color .3s,box-shadow .3s;animation:fadeUp .5s ease}
.card:hover{border-color:rgba(0,200,255,.2);box-shadow:var(--glow)}
.card h3{font-size:14px;margin-bottom:12px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

.sbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:16px}
.si{background:linear-gradient(135deg,rgba(16,16,26,.9),rgba(20,20,40,.9));border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .3s;animation:fadeUp .5s ease}
.si:hover{border-color:rgba(0,200,255,.3);box-shadow:var(--glow);transform:translateY(-2px)}
.si .lb{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}.si .vl{font-size:17px;font-weight:600;margin-top:4px}

.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
.fg{margin-bottom:10px}
.fg label{display:block;font-size:11px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px}
input,select,textarea{width:100%;padding:8px 12px;background:rgba(8,8,15,.8);border:1px solid rgba(40,40,70,.6);border-radius:8px;color:var(--text);font-size:12px;outline:none;font-family:inherit;transition:border-color .3s,box-shadow .3s}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 12px rgba(0,200,255,.15)}
textarea{resize:vertical;min-height:60px;font-family:monospace}
.cb{display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer}
.cb input[type=checkbox]{width:auto;accent-color:var(--accent)}

.btn{padding:7px 16px;border:none;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;color:#fff;transition:all .25s;position:relative;overflow:hidden}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(0,0,0,.3)}
.btn:active{transform:translateY(0)}
.btn-p{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn-p:hover{box-shadow:0 4px 20px rgba(0,200,255,.3)}
.btn-d{background:linear-gradient(135deg,#ff4757,#ff6b81)}
.btn-s{background:linear-gradient(135deg,#2ed573,#7bed9f);color:#000}
.btn-o{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-o:hover{border-color:var(--accent);color:var(--accent)}
.btn-w{background:linear-gradient(135deg,#ffa502,#ffbe76);color:#000}
.btn-sm{padding:4px 10px;font-size:11px}
.bg{display:flex;gap:6px;flex-wrap:wrap}

.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border);font-size:12px}
.tbl th{color:var(--muted);font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:.3px}
.tbl tr{transition:background .2s}.tbl tr:hover{background:rgba(0,200,255,.03)}

.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600}
.b-on{background:rgba(46,213,115,.12);color:var(--success);border:1px solid rgba(46,213,115,.25)}
.b-off{background:rgba(255,71,87,.12);color:var(--danger);border:1px solid rgba(255,71,87,.25)}
.b-pr{background:rgba(0,200,255,.08);color:var(--accent);border:1px solid rgba(0,200,255,.2)}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
.dot-g{background:var(--success);box-shadow:0 0 8px var(--success);animation:pulse 2s infinite}
.dot-r{background:var(--danger);box-shadow:0 0 8px var(--danger)}

.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,0);z-index:1000;align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;transition:background .3s}
.mo.show{display:flex;background:rgba(0,0,0,.7)}
.ml{background:linear-gradient(135deg,rgba(16,16,26,.98),rgba(20,20,40,.98));backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;padding:24px;width:620px;max-width:95vw;margin-bottom:40px;animation:slideIn .35s ease;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ml h3{margin-bottom:14px;font-size:16px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ma{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.sep{border:none;border-top:1px solid var(--border);margin:12px 0}

.lbox{background:rgba(8,8,15,.9);border:1px solid var(--border);border-radius:8px;padding:12px;word-break:break-all;font-family:monospace;font-size:11px;margin:8px 0;line-height:1.5}

.toast-container{position:fixed;bottom:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:10px 18px;border-radius:10px;font-size:12px;font-weight:500;animation:toastIn .4s ease;backdrop-filter:blur(10px);display:flex;align-items:center;gap:8px;box-shadow:0 8px 30px rgba(0,0,0,.3)}
.toast.hiding{animation:toastOut .3s ease forwards}
.toast.ok{background:linear-gradient(135deg,rgba(46,213,115,.9),rgba(46,213,115,.7));color:#000}
.toast.err{background:linear-gradient(135deg,rgba(255,71,87,.9),rgba(255,71,87,.7));color:#fff}
.toast.info{background:linear-gradient(135deg,rgba(0,200,255,.9),rgba(123,47,255,.7));color:#fff}
.toast-icon{font-size:14px}

a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
.cond{display:none}.cond.show{display:block}
.section-title{font-size:12px;font-weight:600;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:12px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.hidden{display:none}
</style>
</head>
<body>
<div class="hdr">
    <div style="display:flex;align-items:center;gap:8px"><img src="data:image/jpeg;base64,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" alt="SelfCode" style="width:32px;height:32px;border-radius:6px"><h1>SelfRay-UI</h1></div>
    <div class="hdr-r"><span>{{ user }}</span><a href="/logout" class="btn btn-o btn-sm">Logout</a></div>
</div>
<div class="wrap">
<div class="tabs">
    <div class="tab active" data-tab="dash">Dashboard</div>
    <div class="tab" data-tab="inbounds">Inbounds</div>
    <div class="tab" data-tab="settings">Settings</div>
</div>

<!-- DASHBOARD -->
<div id="tab-dash" class="tc active">
    <div class="sbar">
        <div class="si"><div class="lb">Xray Status</div><div class="vl" id="xr-st">...</div></div>
        <div class="si"><div class="lb">Xray Version</div><div class="vl" id="xr-ver">‚Äî</div></div>
        <div class="si"><div class="lb">Uptime</div><div class="vl" id="xr-up">‚Äî</div></div>
        <div class="si"><div class="lb">Inbounds</div><div class="vl" id="xr-ib">‚Äî</div></div>
    </div>
    <div class="card">
        <h3>Xray Control</h3>
        <div class="bg">
            <button class="btn btn-s" onclick="xAct('start')">‚ñ∂ Start</button>
            <button class="btn btn-d" onclick="xAct('stop')">‚èπ Stop</button>
            <button class="btn btn-p" onclick="xAct('restart')">‚Üª Restart</button>
            <button class="btn btn-o" onclick="installX()" id="btn-inst">Install Xray</button>
            <button class="btn btn-o" onclick="showConfig()">View Config</button>
        </div>
    </div>
</div>

<!-- INBOUNDS -->
<div id="tab-inbounds" class="tc">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:16px">Inbound List</h3>
        <button class="btn btn-p" onclick="showAddIb()">+ New Inbound</button>
    </div>
    <div id="ib-list"></div>
</div>

<!-- SETTINGS -->
<div id="tab-settings" class="tc">
    <div class="card">
        <h3>Panel Settings</h3>
        <div class="fr3">
            <div class="fg"><label>Panel Port</label><input type="number" id="s-port"></div>
            <div class="fg"><label>Panel Host</label><input type="text" id="s-host"></div>
            <div class="fg"><label>Panel Base Path</label><input type="text" id="s-path"></div>
        </div>
        <div class="fr3">
            <div class="fg"><label>Xray API Port</label><input type="number" id="s-api"></div>
            <div class="fg"><label>Log Level</label>
                <select id="s-log"><option>debug</option><option>info</option><option selected>warning</option><option>error</option><option>none</option></select>
            </div>
            <div class="fg"><label>Subscription Path</label><input type="text" id="s-sub"></div>
        </div>
        <div class="fr">
            <label class="cb"><input type="checkbox" id="s-bt" checked> Block BitTorrent</label>
            <label class="cb"><input type="checkbox" id="s-suben" checked> Enable Subscriptions</label>
        </div>
        <div class="fg"><label>Custom DNS (JSON)</label><textarea id="s-dns" placeholder='{"servers":["1.1.1.1","8.8.8.8"]}'></textarea></div>
        <div class="fg"><label>Custom Routing Rules (JSON array)</label><textarea id="s-rr" placeholder='[{"type":"field","domain":["geosite:category-ads"],"outboundTag":"blocked"}]'></textarea></div>
        <button class="btn btn-p" onclick="saveSets()">Save Settings</button>
        <span style="color:var(--muted);margin-left:8px;font-size:11px">Restart xray after changing xray-related settings</span>
    </div>
    <div class="card">
        <h3>Change Password</h3>
        <div class="fr">
            <div class="fg"><label>Old Password</label><input type="password" id="pw-old"></div>
            <div class="fg"><label>New Password</label><input type="password" id="pw-new"></div>
        </div>
        <button class="btn btn-p" onclick="chPass()">Change</button>
    </div>
    <div class="card">
        <h3>Backup</h3>
        <button class="btn btn-o" onclick="backup()">Download Database Backup</button>
    </div>
</div>
</div>

<!-- ADD INBOUND MODAL -->
<div class="mo" id="m-add-ib">
<div class="ml">
<h3>New Inbound</h3>
<div class="section-title">Protocol</div>
<div class="fr3">
    <div class="fg"><label>Protocol</label>
        <select id="ib-proto" onchange="ibProtoChange()">
            <option value="vless">VLESS</option><option value="vmess">VMess</option><option value="trojan">Trojan</option><option value="shadowsocks">Shadowsocks</option>
        </select>
    </div>
    <div class="fg"><label>Listen IP (empty = all)</label><input type="text" id="ib-listen" placeholder="0.0.0.0"></div>
    <div class="fg"><label>Port</label><input type="number" id="ib-port" value="443"></div>
</div>
<div class="fg"><label>Remark</label><input type="text" id="ib-remark" placeholder="my-proxy"></div>

<div id="grp-vless" class="cond show">
    <div class="section-title">VLESS Settings</div>
    <div class="fr">
        <div class="fg"><label>Flow</label><select id="ib-flow"><option value="">None</option><option value="xtls-rprx-vision" selected>xtls-rprx-vision</option></select></div>
        <div class="fg"><label>Decryption</label><input type="text" id="ib-vless-dec" value="none" readonly></div>
    </div>
</div>
<div id="grp-ss" class="cond">
    <div class="section-title">Shadowsocks Settings</div>
    <div class="fr">
        <div class="fg"><label>Encryption</label><select id="ib-ss-m"><option>chacha20-ietf-poly1305</option><option>aes-256-gcm</option><option>aes-128-gcm</option><option>2022-blake3-aes-128-gcm</option><option>2022-blake3-aes-256-gcm</option><option>2022-blake3-chacha20-poly1305</option></select></div>
        <div class="fg"><label>Password (auto if empty)</label><input type="text" id="ib-ss-pw"></div>
    </div>
    <div class="fg"><label>Network</label><select id="ib-ss-net"><option value="tcp,udp">TCP + UDP</option><option value="tcp">TCP only</option><option value="udp">UDP only</option></select></div>
</div>
<div id="grp-trojan" class="cond">
    <div class="section-title">Trojan Settings</div>
    <div class="fr">
        <div class="fg"><label>Fallback Address</label><input type="text" id="ib-tj-fb-addr" placeholder="127.0.0.1"></div>
        <div class="fg"><label>Fallback Port</label><input type="number" id="ib-tj-fb-port" value="80"></div>
    </div>
</div>

<div id="grp-transport" class="cond show">
    <div class="section-title">Transport</div>
    <div class="fr">
        <div class="fg"><label>Network</label><select id="ib-net" onchange="ibNetChange()"><option value="tcp">TCP (RAW)</option><option value="ws">WebSocket</option><option value="grpc">gRPC</option><option value="h2">HTTP/2</option><option value="httpupgrade">HTTPUpgrade</option></select></div>
        <div class="fg"><label>Security</label><select id="ib-sec" onchange="ibSecChange()"><option value="none">None</option><option value="reality">Reality</option><option value="tls">TLS</option></select></div>
    </div>
    <div id="grp-tcp" class="cond show">
        <div class="fr"><div class="fg"><label>Header Type</label><select id="ib-tcp-ht" onchange="ibTcpHtChange()"><option value="none">none</option><option value="http">http</option></select></div></div>
        <div id="grp-tcp-http" class="cond"><div class="fr"><div class="fg"><label>Request Path</label><input type="text" id="ib-tcp-path" value="/"></div><div class="fg"><label>Request Host</label><input type="text" id="ib-tcp-host"></div></div></div>
    </div>
    <div id="grp-ws" class="cond"><div class="fr"><div class="fg"><label>Path</label><input type="text" id="ib-ws-path" value="/ws"></div><div class="fg"><label>Host Header</label><input type="text" id="ib-ws-host"></div></div></div>
    <div id="grp-grpc" class="cond"><div class="fr"><div class="fg"><label>Service Name</label><input type="text" id="ib-grpc-sn" value="grpc"></div><div class="fg"><label class="cb" style="margin-top:16px"><input type="checkbox" id="ib-grpc-mm"> Multi Mode</label></div></div></div>
    <div id="grp-h2" class="cond"><div class="fr"><div class="fg"><label>Path</label><input type="text" id="ib-h2-path" value="/"></div><div class="fg"><label>Host</label><input type="text" id="ib-h2-host"></div></div></div>
    <div id="grp-hu" class="cond"><div class="fr"><div class="fg"><label>Path</label><input type="text" id="ib-hu-path" value="/"></div><div class="fg"><label>Host</label><input type="text" id="ib-hu-host"></div></div></div>

    <div id="grp-tls" class="cond">
        <div class="section-title">TLS Settings</div>
        <div class="fr">
            <div class="fg"><label>Server Name (SNI)</label><input type="text" id="ib-tls-sni"></div>
            <div class="fg"><label>uTLS Fingerprint</label><select id="ib-tls-fp"><option>chrome</option><option>firefox</option><option>safari</option><option>ios</option><option>android</option><option>edge</option><option>360</option><option>qq</option><option>random</option><option>randomized</option><option>unsafe</option></select></div>
        </div>
        <div class="fr">
            <div class="fg"><label>ALPN</label><input type="text" id="ib-tls-alpn" value="h2,http/1.1"></div>
            <div class="fg"><label class="cb" style="margin-top:16px"><input type="checkbox" id="ib-tls-insec"> Allow Insecure</label></div>
        </div>
        <div class="fr">
            <div class="fg"><label>Certificate File Path</label><input type="text" id="ib-tls-cert" placeholder="/path/to/fullchain.pem"></div>
            <div class="fg"><label>Key File Path</label><input type="text" id="ib-tls-key" placeholder="/path/to/privkey.pem"></div>
        </div>
    </div>
    <div id="grp-reality" class="cond">
        <div class="section-title">Reality Settings</div>
        <div class="fr">
            <div class="fg"><label>Dest (target server)</label><input type="text" id="ib-r-dest" value="google.com:443"></div>
            <div class="fg"><label>Server Names (SNI)</label><input type="text" id="ib-r-sni" value="google.com"></div>
        </div>
        <div class="fg"><label>uTLS Fingerprint</label><select id="ib-r-fp"><option>chrome</option><option>firefox</option><option>safari</option><option>ios</option><option>android</option><option>edge</option><option>360</option><option>qq</option><option>random</option><option>randomized</option><option>unsafe</option></select></div>
        <div class="fr">
            <div class="fg"><label>Private Key</label><input type="text" id="ib-r-priv" placeholder="Click Generate Keys ‚Üì"></div>
            <div class="fg"><label>Public Key</label><input type="text" id="ib-r-pub" placeholder="Click Generate Keys ‚Üì"></div>
        </div>
        <button class="btn btn-o btn-sm" onclick="genRealityKeys()" type="button" style="margin-bottom:8px">üîë Generate Keys</button>
        <div class="fr">
            <div class="fg"><label>Short IDs (comma-separated)</label><input type="text" id="ib-r-sid"></div>
            <div class="fg"><label>SpiderX</label><input type="text" id="ib-r-spx"></div>
        </div>
    </div>
</div>

<div class="section-title">Sniffing</div>
<div class="fr3">
    <label class="cb"><input type="checkbox" id="ib-sniff" checked> Enable Sniffing</label>
    <div class="fg"><label>Dest Override</label><input type="text" id="ib-sniff-do" value="http,tls,quic"></div>
    <label class="cb"><input type="checkbox" id="ib-sniff-ro"> Route Only</label>
</div>
<div class="ma">
    <button class="btn btn-o" onclick="closeM('m-add-ib')">Cancel</button>
    <button class="btn btn-p" onclick="createIb()">Create Inbound</button>
</div>
</div>
</div>

<!-- CLIENT MODAL -->
<div class="mo" id="m-add-cl">
<div class="ml" style="width:450px">
<h3>Add Client</h3>
<input type="hidden" id="cl-ib"><input type="hidden" id="cl-ib-proto">
<div class="fg"><label>Email / Name</label><input type="text" id="cl-email" placeholder="user@mail.com"></div>
<div id="cl-flow-grp" class="fg"><label>Flow</label><select id="cl-flow"><option value="">None</option><option value="xtls-rprx-vision">xtls-rprx-vision</option></select></div>
<div class="fr">
    <div class="fg"><label>Expiry (days, 0=unlimited)</label><input type="number" id="cl-exp" value="30"></div>
    <div class="fg"><label>Traffic Limit (GB, 0=unlimited)</label><input type="number" id="cl-traf" value="0" step="0.1"></div>
</div>
<div class="fg"><label>IP Limit (0=unlimited)</label><input type="number" id="cl-ip" value="0"></div>
<div class="ma">
    <button class="btn btn-o" onclick="closeM('m-add-cl')">Cancel</button>
    <button class="btn btn-p" onclick="addCl()">Add Client</button>
</div>
</div>
</div>

<!-- LINK MODAL -->
<div class="mo" id="m-link">
<div class="ml" style="width:580px">
<h3>Connection Link</h3>
<div id="link-c"></div>
<div class="ma"><button class="btn btn-o" onclick="closeM('m-link')">Close</button></div>
</div>
</div>

<!-- CONFIG MODAL -->
<div class="mo" id="m-config">
<div class="ml" style="width:700px">
<h3>Xray Config</h3>
<textarea id="cfg-view" style="height:400px;font-size:11px" readonly></textarea>
<div class="ma"><button class="btn btn-o" onclick="closeM('m-config')">Close</button></div>
</div>
</div>

<div class="toast-container" id="toast-box"></div>

<script>
async function api(p,o={}){const r=await fetch(p,{headers:{'Content-Type':'application/json',...o.headers},...o});if(r.status===401){location.href='/login';return}return r.json()}

function toast(m,type='ok'){
    const box=document.getElementById('toast-box');
    const t=document.createElement('div');
    const icons={ok:'‚úì',err:'‚úï',info:'‚Ñπ'};
    t.className='toast '+type;
    t.innerHTML='<span class="toast-icon">'+icons[type]+'</span>'+m;
    box.appendChild(t);
    setTimeout(()=>{t.classList.add('hiding');setTimeout(()=>t.remove(),300)},3000);
}
function fmtUp(s){const d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60);return d+'d '+h+'h '+m+'m'}
function closeM(id){const m=document.getElementById(id);m.classList.remove('show')}
document.querySelectorAll('.mo').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show')}));
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tc').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    if(t.dataset.tab==='inbounds')loadIb();if(t.dataset.tab==='settings')loadSets();
}));

let serverIP='';
async function loadSt(){
    const s=await api('/api/status');if(!s)return;
    const el=document.getElementById('xr-st');
    el.innerHTML=s.xray_running?'<span class="dot dot-g"></span>Running ('+s.pid+')':'<span class="dot dot-r"></span>Stopped';
    document.getElementById('xr-up').textContent=fmtUp(s.uptime);
    if(s.server_ip)serverIP=s.server_ip;
    const v=await api('/api/xray/version');
    document.getElementById('xr-ver').textContent=v.installed?v.version:'Not installed';
    document.getElementById('btn-inst').textContent=v.installed?'Reinstall':'Install Xray';
}
async function xAct(a){const r=await api('/api/xray/'+a,{method:'POST'});toast(r.success?a+' OK':'Error',r.success?'ok':'err');loadSt()}
async function installX(){const b=document.getElementById('btn-inst');b.textContent='Installing...';b.disabled=true;const r=await api('/api/xray/install',{method:'POST'});toast(r.success?'Installed: '+r.version:'Failed: '+(r.error||''),r.success?'ok':'err');b.disabled=false;loadSt()}
async function showConfig(){const c=await api('/api/xray/config');document.getElementById('cfg-view').value=JSON.stringify(c,null,2);document.getElementById('m-config').classList.add('show')}

async function loadIb(){
    const data=await api('/api/inbounds');if(!data)return;
    document.getElementById('xr-ib').textContent=data.length;
    if(!data.length){document.getElementById('ib-list').innerHTML='<div class="card" style="text-align:center;color:var(--muted)">No inbounds yet. Click "+ New Inbound" to get started.</div>';return}
    let h='';
    for(const ib of data){
        const st=JSON.parse(ib.stream_settings),net=st.network||'tcp',sec=st.security||'none';
        h+='<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:10px">';
        h+='<div><span class="badge b-pr">'+ib.protocol.toUpperCase()+'</span> <span class="badge '+(ib.enabled?'b-on':'b-off')+'">'+(ib.enabled?'ON':'OFF')+'</span>';
        h+=' <strong style="margin-left:6px">'+(ib.remark||ib.tag)+'</strong>';
        h+='<span style="color:var(--muted);margin-left:8px;font-size:11px">:'+ib.port+' | '+net+' | '+sec+'</span></div>';
        h+='<div class="bg"><button class="btn btn-sm btn-o" onclick="toggleIb('+ib.id+')">'+(ib.enabled?'Disable':'Enable')+'</button>';
        h+='<button class="btn btn-sm btn-s" onclick="showAddCl('+ib.id+',\''+ib.protocol+'\')">+ Client</button>';
        h+='<button class="btn btn-sm btn-d" onclick="delIb('+ib.id+')">Delete</button></div></div>';
        if(ib.clients&&ib.clients.length){
            h+='<table class="tbl"><tr><th>Email</th><th>UUID/Pass</th><th>Flow</th><th>Status</th><th>Actions</th></tr>';
            for(const c of ib.clients){
                h+='<tr><td>'+c.email+'</td><td style="font-family:monospace;font-size:11px" title="'+c.uuid+'">'+c.uuid.substring(0,12)+'...</td>';
                h+='<td>'+(c.flow||'‚Äî')+'</td><td><span class="badge '+(c.enabled?'b-on':'b-off')+'">'+(c.enabled?'ON':'OFF')+'</span></td>';
                h+='<td class="bg"><button class="btn btn-sm btn-p" onclick="showLink(\''+c.id+'\')">Link</button>';
                h+='<button class="btn btn-sm btn-o" onclick="copySub(\''+c.id+'\')">Sub</button>';
                h+='<button class="btn btn-sm btn-w" onclick="rstTraf(\''+c.id+'\')">Reset</button>';
                h+='<button class="btn btn-sm btn-d" onclick="delCl(\''+c.id+'\')">‚úï</button></td></tr>';
            }
            h+='</table>';
        }else h+='<div style="color:var(--muted);font-size:12px">No clients</div>';
        h+='</div>';
    }
    document.getElementById('ib-list').innerHTML=h;
}

function showAddIb(){document.getElementById('m-add-ib').classList.add('show');if(serverIP)document.getElementById('ib-listen').value=serverIP;ibProtoChange()}
function condShow(id,show){document.getElementById(id).classList.toggle('show',show);document.getElementById(id).classList.toggle('cond',!show)}
function ibProtoChange(){
    const p=document.getElementById('ib-proto').value;
    condShow('grp-vless',p==='vless');condShow('grp-ss',p==='shadowsocks');condShow('grp-trojan',p==='trojan');
    condShow('grp-transport',p!=='shadowsocks');ibNetChange();ibSecChange();
}
function ibNetChange(){
    const n=document.getElementById('ib-net').value;
    ['tcp','ws','grpc','h2','hu'].forEach(x=>condShow('grp-'+x,false));
    if(n==='tcp')condShow('grp-tcp',true);else if(n==='ws')condShow('grp-ws',true);else if(n==='grpc')condShow('grp-grpc',true);else if(n==='h2')condShow('grp-h2',true);else if(n==='httpupgrade')condShow('grp-hu',true);
}
function ibSecChange(){const s=document.getElementById('ib-sec').value;condShow('grp-tls',s==='tls');condShow('grp-reality',s==='reality')}
function ibTcpHtChange(){condShow('grp-tcp-http',document.getElementById('ib-tcp-ht').value==='http')}

async function genRealityKeys(){
    try{
        const r=await fetch('/api/generate-reality-keys',{method:'POST',headers:{'Content-Type':'application/json'}});
        const data=await r.json();
        if(r.ok&&data.private_key){document.getElementById('ib-r-priv').value=data.private_key;document.getElementById('ib-r-pub').value=data.public_key;toast('Keys generated','ok')}
        else toast(data.detail||'Failed','err');
    }catch(e){toast('Error: '+e.message,'err')}
}

async function createIb(){
    const body={
        protocol:document.getElementById('ib-proto').value,port:+document.getElementById('ib-port').value,
        listen:document.getElementById('ib-listen').value,remark:document.getElementById('ib-remark').value,
        network:document.getElementById('ib-net').value,security:document.getElementById('ib-sec').value,
        flow:document.getElementById('ib-flow').value,vless_decryption:document.getElementById('ib-vless-dec').value,
        tcp_header_type:document.getElementById('ib-tcp-ht').value,tcp_header_request_path:document.getElementById('ib-tcp-path').value,
        tcp_header_request_host:document.getElementById('ib-tcp-host').value,ws_path:document.getElementById('ib-ws-path').value,
        ws_host:document.getElementById('ib-ws-host').value,grpc_service_name:document.getElementById('ib-grpc-sn').value,
        grpc_multi_mode:document.getElementById('ib-grpc-mm').checked,h2_path:document.getElementById('ib-h2-path').value,
        h2_host:document.getElementById('ib-h2-host').value,httpupgrade_path:document.getElementById('ib-hu-path').value,
        httpupgrade_host:document.getElementById('ib-hu-host').value,tls_server_name:document.getElementById('ib-tls-sni').value,
        tls_fingerprint:document.getElementById('ib-tls-fp').value,tls_alpn:document.getElementById('ib-tls-alpn').value,
        tls_allow_insecure:document.getElementById('ib-tls-insec').checked,tls_cert_file:document.getElementById('ib-tls-cert').value,
        tls_key_file:document.getElementById('ib-tls-key').value,reality_dest:document.getElementById('ib-r-dest').value,
        reality_server_names:document.getElementById('ib-r-sni').value,reality_private_key:document.getElementById('ib-r-priv').value,
        reality_public_key:document.getElementById('ib-r-pub').value,reality_short_ids:document.getElementById('ib-r-sid').value,
        reality_spider_x:document.getElementById('ib-r-spx').value,reality_fingerprint:document.getElementById('ib-r-fp').value,
        ss_method:document.getElementById('ib-ss-m').value,ss_password:document.getElementById('ib-ss-pw').value,
        ss_network:document.getElementById('ib-ss-net').value,trojan_fallback_addr:document.getElementById('ib-tj-fb-addr').value,
        trojan_fallback_port:+document.getElementById('ib-tj-fb-port').value||0,sniffing_enabled:document.getElementById('ib-sniff').checked,
        sniffing_dest_override:document.getElementById('ib-sniff-do').value,sniffing_route_only:document.getElementById('ib-sniff-ro').checked,
    };
    const r=await api('/api/inbounds',{method:'POST',body:JSON.stringify(body)});
    if(r.success){toast('Inbound created','ok');closeM('m-add-ib');loadIb();loadSt()}else toast(r.detail||'Error','err');
}

async function delIb(id){if(!confirm('Delete this inbound?'))return;await api('/api/inbounds/'+id,{method:'DELETE'});toast('Deleted','info');loadIb()}
async function toggleIb(id){await api('/api/inbounds/'+id+'/toggle',{method:'PUT'});toast('Toggled','info');loadIb()}

function showAddCl(id,proto){
    document.getElementById('cl-ib').value=id;document.getElementById('cl-ib-proto').value=proto;
    document.getElementById('cl-email').value='';
    document.getElementById('cl-flow-grp').style.display=proto==='vless'?'':'none';
    document.getElementById('m-add-cl').classList.add('show');
}
async function addCl(){
    const r=await api('/api/inbounds/'+document.getElementById('cl-ib').value+'/clients',{method:'POST',body:JSON.stringify({
        email:document.getElementById('cl-email').value,flow:document.getElementById('cl-flow').value,
        expiry_days:+document.getElementById('cl-exp').value||0,traffic_limit_gb:+document.getElementById('cl-traf').value||0,
        ip_limit:+document.getElementById('cl-ip').value||0,
    })});
    if(r.success){toast('Client added','ok');closeM('m-add-cl');loadIb()}else toast(r.detail||'Error','err');
}
async function delCl(id){if(!confirm('Delete client?'))return;await api('/api/clients/'+id,{method:'DELETE'});toast('Client deleted','info');loadIb()}
async function rstTraf(id){await api('/api/clients/'+id+'/reset-traffic',{method:'POST'});toast('Traffic reset','ok');loadIb()}

async function showLink(cid){
    const r=await api('/api/clients/'+cid+'/link');if(!r)return;
    const subLink=location.origin+'/sub/'+cid;
    let html='<div class="lbox" id="link-text">'+r.link+'</div>';
    html+='<button class="btn btn-p" id="btn-cp-link" style="width:100%;margin-top:6px">Copy Connection Link</button>';
    html+='<p style="font-size:11px;color:var(--muted);margin-top:10px">'+r.protocol.toUpperCase()+' | '+r.host+':'+r.port+'</p>';
    html+='<div style="margin-top:10px"><div class="section-title">Subscription Link</div>';
    html+='<div class="lbox" id="sub-text">'+subLink+'</div>';
    html+='<button class="btn btn-o" id="btn-cp-sub" style="width:100%;margin-top:6px">Copy Subscription Link</button></div>';
    document.getElementById('link-c').innerHTML=html;
    document.getElementById('btn-cp-link').onclick=function(){navigator.clipboard.writeText(r.link);toast('Link copied','ok');this.textContent='‚úì Copied';setTimeout(()=>this.textContent='Copy Connection Link',2000)};
    document.getElementById('btn-cp-sub').onclick=function(){navigator.clipboard.writeText(subLink);toast('Sub link copied','ok');this.textContent='‚úì Copied';setTimeout(()=>this.textContent='Copy Subscription Link',2000)};
    document.getElementById('m-link').classList.add('show');
}
function copySub(cid){navigator.clipboard.writeText(location.origin+'/sub/'+cid);toast('Sub link copied','ok')}

async function loadSets(){
    const s=await api('/api/settings');if(!s)return;
    document.getElementById('s-port').value=s.panel_port;document.getElementById('s-host').value=s.panel_host;
    document.getElementById('s-path').value=s.panel_path;document.getElementById('s-api').value=s.xray_api_port;
    document.getElementById('s-log').value=s.xray_log_level;document.getElementById('s-sub').value=s.sub_path;
    document.getElementById('s-bt').checked=s.block_bittorrent;document.getElementById('s-suben').checked=s.sub_enable;
    document.getElementById('s-dns').value=s.custom_dns;document.getElementById('s-rr').value=s.custom_routing_rules;
}
async function saveSets(){
    const r=await api('/api/settings',{method:'POST',body:JSON.stringify({
        panel_port:+document.getElementById('s-port').value,panel_host:document.getElementById('s-host').value,
        panel_path:document.getElementById('s-path').value,xray_api_port:+document.getElementById('s-api').value,
        xray_log_level:document.getElementById('s-log').value,sub_path:document.getElementById('s-sub').value,
        block_bittorrent:document.getElementById('s-bt').checked,sub_enable:document.getElementById('s-suben').checked,
        custom_dns:document.getElementById('s-dns').value,custom_routing_rules:document.getElementById('s-rr').value,
    })});toast(r.success?'Settings saved':'Error',r.success?'ok':'err');
}
async function chPass(){
    const r=await api('/api/change-password',{method:'POST',body:JSON.stringify({old_password:document.getElementById('pw-old').value,new_password:document.getElementById('pw-new').value})});
    if(r.success){toast('Password changed','ok');document.getElementById('pw-old').value='';document.getElementById('pw-new').value=''}else toast(r.detail||'Error','err');
}
async function backup(){
    const r=await api('/api/backup');if(r.database){
        const a=document.createElement('a');a.href='data:application/octet-stream;base64,'+r.database;
        a.download='selfray-backup-'+new Date().toISOString().slice(0,10)+'.db';a.click();toast('Backup downloaded','ok')}
}

loadSt();loadIb();setInterval(loadSt,15000);
</script>
</body>
</html>
